<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZWITSCHERN.CHAT</title>
    <link rel="stylesheet" href="../styles.css">
  
     <!-- Favicon hinzufügen -->
     <link rel="icon" type="image/png" sizes="32x32" href="../assets/Zwitschern.Chat_LOGO.png">
   
     <!-- Website-Beschreibung hinzufügen -->
     <meta name="description" content="Zwitschern.Chat - DER CHAT FÜR ALLE!">
   
     <!-- Für soziale Medien optimierte Metadaten -->
     <meta property="og:title" content="Zwitschern.Chat">
     <meta property="og:description" content="DER CHAT FÜR ALLE!">
     <meta property="og:image" content="../assets/Zwitschern.Chat_LOGO.png">
     <meta property="og:type" content="website">
  
  </head>
<body>
<div class="blur-background"></div>

<!-- Header of Website -->
<div class="header">
    <!-- Logo of Website -->
  <img src="../assets/Zwitschern.Chat_LOGO.png" alt="Logo" class="zwitschern-chat-logo" onclick="redirectToHome()" />
  <div class="header__text">
    <div class="header__title">ZWITSCHERN.CHAT</div>
    <div class="header__subtitle">DER CHAT FÜR ALLE!</div>
  </div>
  <img src="../assets/logout.png" alt="Account" class="account" onclick="window.location.href='https://zwitschern.chat/auth/v1.0/logout'">
</div>

<!-- Container für Nutzername und Profilbild -->
<div id="user-profile" class="user-profile hide">
  <img id="user-profile-picture" src="" alt=" " style="width: 100px; height: 100px; border-radius: 50%;">
  <div id="user-name-container">
    <span id="user-name-display"></span>
    <input type="text" id="user-name-input" style="display:none;" />
    <button onclick="toggleEdit('user-name')" style="border: none; background-color: transparent; cursor: pointer;">
      <img src="../assets/edit.png" alt="Edit" style="width: 20px; height: 20px; margin: -4px;">
    </button>
  </div>
  <!-- Ähnliche Container für Bio und Sprache hinzufügen -->
  <div id="user-email-display"></div>
  <div id="user-creation-date-display"></div>
  <div id="user-bio-display"></div>
  <div id="user-language-display"></div>
  <div id="old-user-name-display"></div>
</div>


<script>
// Fügen Sie ein Event-Listener hinzu, um die Klasse "loaded" zum Header hinzuzufügen, wenn die Seite geladen ist
window.addEventListener('load', function() {
    document.querySelector('.header').classList.add('loaded');
});



  // Hilfsfunktion, um den Benutzer zur Startseite zu leiten
  function redirectToHome() {
    var baseUrl = window.location.href.split('/account')[0];
    window.location.href = baseUrl;
}


// only fetch user data if not on localhost
if (!window.location.hostname.includes('localhost')) {
  // Rufen Sie die Funktion beim Laden der Seite auf
  window.onload = fetchAuthUserData;
} else {
  document.getElementById('user-profile-picture').src = 'https://via.placeholder.com/100';
  document.getElementById('user-name-display').textContent = 'Nicht verfügbar auf localhost';
  document.getElementById('user-email-display').textContent = 'E-Mail: Nicht verfügbar';
  document.getElementById('user-creation-date-display').textContent = 'Erstellt am: Nicht verfügbar';
  document.getElementById('user-bio-display').textContent = 'Bio: Nicht verfügbar';
  document.getElementById('user-language-display').textContent = 'Sprache: Nicht verfügbar';
}

function toggleEdit(elementId) {
  const displaySpan = document.getElementById(`${elementId}-display`);
  const inputField = document.getElementById(`${elementId}-input`);
  if (inputField.style.display === "none") {
    inputField.value = displaySpan.textContent.replace('Nutzername: ', ''); // Entfernen des Präfixes
    inputField.style.display = "";
    displaySpan.style.display = "none";
  } else {
    inputField.style.display = "none";
    displaySpan.style.display = "";
    updateUserData(elementId, inputField.value); // Sendet die Änderung an den Server
  }
}

function updateUserData(field, newValue) {
   let newUsername = document.getElementById('user-name-input').value;
  if (!newUsername) {
    alert('Bitte geben Sie einen Benutzernamen ein');
    return;
  } 
  fetch('/auth/v1.0/user')
  .then(response => {
    if (response.ok) {
      return response.json();
    } 
  })
  .then(data => {
    const sub = data.sub;

    // Verwenden Sie die aktualisierten Variablen, um die nächste Anfrage zu machen
    return fetch(`/api/v1.0/user_sub/${sub}`);
  })
  .then(response => {
    if (response.ok) {
      return response.json();
    }
  })
  .then(data => {
    const user_number = data.number;
    console.log(user_number);




    return fetch('/auth/v1.0/username', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        user_number: user_number,
        username: newUsername
      })
    })
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Fehler beim Aktualisieren des Benutzernamens');
      }
    })
    .then(data => {
      document.getElementById(`${field}-display`).textContent = `Nutzername: ${newValue}`;
      console.log('Benutzername erfolgreich aktualisiert', data);
    })
    .catch(error => {
      console.error('Fehler:', error);
    });
  })
  .catch(error => {
    console.error('Fehler:', error);
  });
}

// Funktion, um Nutzerdaten vom Auth-Server zu holen  
function fetchAuthUserData() {
  fetch('/auth/v1.0/user')
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Nicht authentifiziert');
      }
    })
    .then(data => {
      document.getElementById('old-user-name-display').textContent = `Alter Nutzername: ${data.nickname || data.name}`;
      if(data.picture) {
        document.getElementById('user-profile-picture').src = data.picture;
      }
      if(data.email) {
        document.getElementById('user-email-display').textContent = `E-Mail: ${data.email}`;
      }
      // Hier rufst du fetchApiUserData mit der user id (sub) auf
      if(data.sub) {
        fetchApiUserData(data.sub);
      }
    })
    .catch(error => {
      console.error('Keine Nutzerdaten vorhanden:', error);
      window.location.href = 'https://zwitschern.chat/auth/v1.0/login';
    });
}

  // Funktion, um Nutzerdaten vom API-Server zu holen
  function fetchApiUserData(sub) {
  fetch(`/api/v1.0/user_sub/${sub}`)
    .then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Nutzerdaten konnten nicht abgerufen werden');
      }
    })
    .then(data => {
      document.getElementById('user-name-display').textContent = `Nutzername: ${data.username}`;
      document.getElementById('user-name-input').value = data.username;
      document.getElementById('user-creation-date-display').textContent = `Erstellt am: ${new Date(data.created_at).toLocaleDateString()}`; 
      if(data.bio) {
        document.getElementById('user-bio-display').textContent = `Bio: ${data.bio}`; 
      } else {
        document.getElementById('user-bio-display').textContent = 'Bio: Noch nicht angegeben';
      }
      if(data.language) {
        document.getElementById('user-language-display').textContent = `Sprache: ${data.language}`; 
      } else {
        document.getElementById('user-language-display').textContent = 'Sprache: Noch nicht angegeben';
      }
    })
    .catch(error => {
      console.error('Fehler beim Abrufen der Nutzerdaten:', error);
    });
    let userProfile = document.getElementById('user-profile');
    userProfile.classList.remove('hide');
}




</script>

</body>
</html>
