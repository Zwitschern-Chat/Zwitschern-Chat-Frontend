<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zwitschern.Chat</title>
  <link rel="stylesheet" href="../styles.css">
</head>
<body>
<div class="blur-background"></div>

<!-- Header of Website -->
<div class="header">
    <!-- Logo of Website -->
  <img src="../assets/Zwitschern.Chat_LOGO.png" alt="Logo" class="zwitschern-chat-logo" onclick="redirectToHome()" />
  <div class="header__text">
    <div class="header__title">ZWITSCHERN.CHAT</div>
    <div class="header__subtitle">DER CHAT FÜR ALLE!</div>
  </div>
  <img src="../assets/logout.png" alt="Account" class="account" onclick="window.location.href='https://zwitschern.chat/auth/logout'">
</div>

<!-- Container für Nutzername und Profilbild -->
<div id="user-profile">
  <img id="user-profile-picture" src="" alt=" " style="width: 100px; height: 100px; border-radius: 50%;">
  <div id="user-name-display"></div>
  <div id="user-email-display"></div>
  <div id="user-role-display"></div>
</div>

<script>
  function redirectToHome() {
    var baseUrl = window.location.href.split('/account')[0];
    window.location.href = baseUrl;
}

  if (!window.location.hostname.includes('localhost')) {
  function fetchUserData() {
    fetch('/auth/user')
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Nicht authentifiziert');
        }
      })
      .then(data => {
        // Nutzerdaten erfolgreich abgerufen, aktualisieren Sie das Frontend
        document.getElementById('user-name-display').textContent = `Nutername: ${data.username}`;
        if(data.profilePictureUrl) {
          document.getElementById('user-profile-picture').src = data.profilePictureUrl;
        }
        if(data.email) {
          document.getElementById('user-email-display').textContent = `E-Mail: ${data.email}`;
        }
        // Zusätzliche API-Anfrage um die Rolle des Nutzers abzufragen
        fetchUserRole(data.email);
      })
      .catch(error => {
        console.error('Keine Nutzerdaten vorhanden:', error);
        window.location.href = 'https://zwitschern.chat/auth/login';
      });
  }

  // Funktion, um die Rolle des Nutzers über die API abzufragen
  function fetchUserRole(email) {
// Setze die Basis-URL basierend auf dem Hostnamen der Seite
const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : 'https://zwitschern.chat/api';


    const apiUrl = `${API_BASE_URL}/users?email=${encodeURIComponent(email)}`;
    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        const user = data.find(user => user.email === email);
        if(user && user.role) {
          document.getElementById('user-role-display').textContent = `Rolle: ${user.role}`;
        } else {
          document.getElementById('user-role-display').textContent = 'Rolle: Nicht verfügbar';
        }
      })
      .catch(error => {
        console.error('Fehler beim Abrufen der Nutzerrolle:', error);
        document.getElementById('user-role-display').textContent = 'Rolle: Fehler beim Abrufen';
      });
  }

  // Rufen Sie die Funktion beim Laden der Seite auf
  window.onload = fetchUserData;
} else {
  document.getElementById('user-name-display').textContent = 'Nicht eingeloggt';
  document.getElementById('user-profile-picture').src = 'https://via.placeholder.com/100';
  document.getElementById('user-email-display').textContent = 'E-Mail: Nicht verfügbar';
  document.getElementById('user-role-display').textContent = 'Rolle: Nicht verfügbar';
}
</script>

</body>
</html>
